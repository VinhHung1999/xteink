# Backend Architecture â€” Sprint 4

**Author:** TL
**Date:** 2026-02-12
**Stack:** Node.js + Express + TypeScript + PostgreSQL + Prisma ORM
**Directory:** `backend/`
**Port:** 3001

---

## 1. Directory Structure

```
backend/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma          # Database schema
â”‚   â”œâ”€â”€ seed.ts                # Seed all mock data from FE
â”‚   â””â”€â”€ migrations/            # Auto-generated by Prisma
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts               # Entry: start server
â”‚   â”œâ”€â”€ app.ts                 # Express app (middleware, routes)
â”‚   â”œâ”€â”€ config.ts              # Env vars, constants
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ index.ts           # Mount all route modules
â”‚   â”‚   â”œâ”€â”€ health.ts          # GET /api/health
â”‚   â”‚   â”œâ”€â”€ products.ts        # GET /api/products, /api/products/:slug
â”‚   â”‚   â”œâ”€â”€ features.ts        # GET /api/features
â”‚   â”‚   â”œâ”€â”€ pricing.ts         # GET /api/pricing
â”‚   â”‚   â”œâ”€â”€ testimonials.ts    # GET /api/testimonials
â”‚   â”‚   â”œâ”€â”€ lifestyle.ts       # GET /api/lifestyle-moments
â”‚   â”‚   â”œâ”€â”€ navigation.ts      # GET /api/navigation
â”‚   â”‚   â”œâ”€â”€ footer.ts          # GET /api/footer
â”‚   â”‚   â”œâ”€â”€ snap-flip-read.ts  # GET /api/snap-flip-read
â”‚   â”‚   â”œâ”€â”€ comparison.ts      # GET /api/product-comparison
â”‚   â”‚   â”œâ”€â”€ accessories.ts     # GET /api/accessories
â”‚   â”‚   â”œâ”€â”€ purchase-info.ts   # GET /api/purchase-info
â”‚   â”‚   â”œâ”€â”€ faq.ts             # GET /api/faq
â”‚   â”‚   â”œâ”€â”€ social-proof.ts    # GET /api/social-proof
â”‚   â”‚   â”œâ”€â”€ guides.ts          # GET /api/guides
â”‚   â”‚   â”œâ”€â”€ addresses.ts       # GET /api/addresses/*
â”‚   â”‚   â””â”€â”€ checkout.ts        # GET /api/checkout/payment-methods
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ error.ts           # Global error handler
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ prisma.ts          # Prisma client singleton
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ .prettierrc
â””â”€â”€ nodemon.json
```

**Principles:**
- One route file per resource (matches one FE api function)
- No controllers/services layer yet â€” routes call Prisma directly. Add layers when complexity warrants it (Sprint 5+).
- `lib/prisma.ts` exports singleton PrismaClient to avoid multiple connections in dev.

---

## 2. Critical Design Decision: LucideIcon â†’ String Mapping

### The Problem

8 FE types reference `LucideIcon` (a React component type):

| Type | Field |
|------|-------|
| ProductFeature | `icon: LucideIcon` |
| SnapFlipReadStep | `icon: LucideIcon` |
| TrustBadge | `icon: LucideIcon` |
| PaymentMethod | `icon: LucideIcon` |
| ShippingInfo | `icon: LucideIcon` |
| WarrantyInfo | `icon: LucideIcon` |
| BundleItem | `icon: LucideIcon` |
| Guide | `icon: LucideIcon` |

BE cannot return React component references.

### The Solution

**BE returns `icon: string`** â€” the Lucide icon name in kebab-case:

```
Feather     â†’ "feather"
VolumeX     â†’ "volume-x"
HardDrive   â†’ "hard-drive"
Truck       â†’ "truck"
QrCode      â†’ "qr-code"
BookOpen    â†’ "book-open"
etc.
```

**FE creates an icon resolver** (part of BE1.5 integration work):

```typescript
// website/src/utils/icon-map.ts
import { Feather, VolumeX, HardDrive, ... } from "lucide-react";
import { LucideIcon } from "lucide-react";

const iconMap: Record<string, LucideIcon> = {
  "feather": Feather,
  "volume-x": VolumeX,
  "hard-drive": HardDrive,
  // ... all icons used in mock data
};

export function resolveIcon(name: string): LucideIcon {
  return iconMap[name] ?? Circle; // fallback to Circle
}
```

**Impact on FE types:**
- Types with `icon: LucideIcon` stay as-is in FE components
- Only `api.ts` changes: fetch JSON with `icon: string`, map to `LucideIcon` before returning
- Zero component changes â€” this is the whole point of the services layer

### Icon Name Reference (for seed data)

| Mock import | BE icon string |
|-------------|---------------|
| `Feather` | `"feather"` |
| `VolumeX` | `"volume-x"` |
| `HardDrive` | `"hard-drive"` |
| `Truck` | `"truck"` |
| `RefreshCw` | `"refresh-cw"` |
| `MessageCircle` | `"message-circle"` |
| `QrCode` | `"qr-code"` |
| `Wallet` | `"wallet"` |
| `CreditCard` | `"credit-card"` |
| `Banknote` | `"banknote"` |
| `MapPin` | `"map-pin"` |
| `Package` | `"package"` |
| `ShieldCheck` | `"shield-check"` |
| `Smartphone` | `"smartphone"` |
| `Cpu` | `"cpu"` |
| `BookOpen` | `"book-open"` |
| `Film` | `"film"` |
| `Circle` | `"circle"` |
| `Magnet` | `"magnet"` |
| `Sparkles` | `"sparkles"` |
| `FolderSync` | `"folder-sync"` |

---

## 3. Database Schema (Prisma)

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// PRODUCTS
// =============================================

model Product {
  id            String   @id @default(cuid())
  slug          String   @unique          // "x4", "x3"
  name          String                    // "Xteink X4"
  tag           String?                   // "Bestseller", "2026 New"
  subtitle      String?                   // "Rethink Reading"
  description   String
  image         String                    // primary image URL
  price         String                    // formatted: "1.590.000â‚«"
  priceNumeric  Int                       // 1590000 (for comparison/sorting)
  originalPrice String?                   // "1.890.000â‚«" (strikethrough)
  // Comparison-specific fields
  screenSpec    String?                   // "4.3\""
  ppiSpec       String?                   // "220 PPI"
  weightSpec    String?                   // "74g"
  thicknessSpec String?                   // "4.9mm"
  advantages    String[]                  // ["screen", "price", "thickness"]
  specsList     String[]                  // ["4.3\" E-Ink", "220 PPI", ...]
  features      ProductFeature[]
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ProductFeature {
  id          String  @id @default(cuid())
  productId   String
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  icon        String                      // Lucide icon name
  title       String
  description String
  sortOrder   Int     @default(0)
}

// =============================================
// ACCESSORIES
// =============================================

model Accessory {
  id        String           @id @default(cuid())
  name      String
  price     String                        // formatted: "210.000â‚«"
  image     String
  category  String                        // "standalone" | "pricing"
  sortOrder Int              @default(0)
  colors    AccessoryColor[]
}

model AccessoryColor {
  id          String    @id @default(cuid())
  accessoryId String
  accessory   Accessory @relation(fields: [accessoryId], references: [id], onDelete: Cascade)
  name        String                      // "Midnight Black"
  hex         String                      // "#1A1A1A"
  sortOrder   Int       @default(0)
}

// =============================================
// CONTENT: Features Grid
// =============================================

model Feature {
  id          String @id @default(cuid())
  image       String
  title       String
  description String
  sortOrder   Int    @default(0)
}

// =============================================
// CONTENT: Snap Flip Read (USP)
// =============================================

model SnapFlipReadStep {
  id          String @id @default(cuid())
  step        String                      // "Snap", "Flip", "Read"
  icon        String                      // Lucide icon name
  title       String
  description String
  sortOrder   Int    @default(0)
}

// =============================================
// CONTENT: Testimonials
// =============================================

model Testimonial {
  id        String @id @default(cuid())
  quote     String
  name      String
  location  String
  sortOrder Int    @default(0)
}

// =============================================
// CONTENT: Lifestyle Moments
// =============================================

model LifestyleMoment {
  id        String @id @default(cuid())
  image     String
  caption   String
  sortOrder Int    @default(0)
}

// =============================================
// CONTENT: FAQ
// =============================================

model FAQItem {
  id        String @id @default(cuid())
  question  String
  answer    String
  sortOrder Int    @default(0)

  @@map("faq_items")
}

// =============================================
// CONTENT: Guides
// =============================================

model Guide {
  id          String @id @default(cuid())
  icon        String                      // Lucide icon name
  title       String
  description String
  href        String
  sortOrder   Int    @default(0)
}

// =============================================
// NAVIGATION
// =============================================

model NavLink {
  id        String @id @default(cuid())
  label     String
  href      String
  sortOrder Int    @default(0)

  @@map("nav_links")
}

// =============================================
// FOOTER
// =============================================

model FooterLink {
  id        String @id @default(cuid())
  section   String                        // "product" | "support"
  label     String
  href      String
  sortOrder Int    @default(0)

  @@map("footer_links")
}

model FooterPaymentMethod {
  id        String @id @default(cuid())
  name      String                        // "MoMo", "ZaloPay", etc.
  sortOrder Int    @default(0)

  @@map("footer_payment_methods")
}

// =============================================
// PRICING
// =============================================

model PricingConfig {
  id            String @id @default(cuid())
  label         String                    // "Xteink X4"
  price         String                    // "1.590.000â‚«"
  originalPrice String                    // "1.890.000â‚«"

  @@map("pricing_config")
}

model PricingIncludedItem {
  id        String @id @default(cuid())
  text      String
  sortOrder Int    @default(0)

  @@map("pricing_included_items")
}

model TrustBadge {
  id        String @id @default(cuid())
  icon      String                        // Lucide icon name
  label     String
  sortOrder Int    @default(0)

  @@map("trust_badges")
}

// =============================================
// PURCHASE INFO
// =============================================

model PurchasePaymentMethod {
  id          String @id @default(cuid())
  icon        String                      // Lucide icon name
  name        String
  description String
  sortOrder   Int    @default(0)

  @@map("purchase_payment_methods")
}

model ShippingInfo {
  id        String  @id @default(cuid())
  icon      String                        // Lucide icon name
  region    String
  time      String
  note      String?
  sortOrder Int     @default(0)

  @@map("shipping_info")
}

model WarrantyInfo {
  id          String @id @default(cuid())
  icon        String                      // Lucide icon name
  title       String
  description String
  sortOrder   Int    @default(0)

  @@map("warranty_info")
}

model BundleItem {
  id        String @id @default(cuid())
  icon      String                        // Lucide icon name
  name      String
  sortOrder Int    @default(0)

  @@map("bundle_items")
}

// =============================================
// SOCIAL PROOF
// =============================================

model PressReview {
  id        String  @id @default(cuid())
  name      String
  rating    Float
  maxRating Float
  quote     String?
  sortOrder Int     @default(0)

  @@map("press_reviews")
}

model YouTubeReview {
  id           String  @id @default(cuid())
  channel      String
  subscribers  String
  title        String
  url          String
  thumbnailUrl String?

  @@map("youtube_reviews")
}

model CommunityTestimonial {
  id        String @id @default(cuid())
  quote     String
  name      String
  source    String
  sortOrder Int    @default(0)

  @@map("community_testimonials")
}

// =============================================
// CHECKOUT
// =============================================

model CheckoutPaymentMethod {
  id          String @id @default(cuid())
  methodId    String @unique              // "cod", "momo", "zalopay", etc.
  name        String
  description String
  icon        String                      // emoji: "ðŸ“¦", "ðŸ’œ"
  sortOrder   Int    @default(0)

  @@map("checkout_payment_methods")
}

// =============================================
// ADDRESSES (Vietnam)
// =============================================

model Province {
  id        String     @id @default(cuid())
  code      String     @unique
  name      String
  sortOrder Int        @default(0)
  districts District[]
}

model District {
  id         String   @id @default(cuid())
  code       String   @unique
  name       String
  provinceId String
  province   Province @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  sortOrder  Int      @default(0)
  wards      Ward[]
}

model Ward {
  id         String   @id @default(cuid())
  code       String   @unique
  name       String
  districtId String
  district   District @relation(fields: [districtId], references: [id], onDelete: Cascade)
  sortOrder  Int      @default(0)
}

// =============================================
// SITE CONFIG (key-value for one-off values)
// =============================================

model SiteConfig {
  id    String @id @default(cuid())
  key   String @unique                    // "freeShippingNote", "communityStat"
  value String

  @@map("site_config")
}
```

---

## 4. API Endpoints â†’ FE Type Mapping

Every endpoint MUST return data matching the FE type exactly. For types with `LucideIcon`, BE returns `icon: string` and FE maps it during integration (BE1.5).

### 4.1 Content APIs (BE1.2) â€” 15 GET endpoints

| # | Endpoint | FE Type | DB Source | Notes |
|---|----------|---------|-----------|-------|
| 1 | `GET /api/products` | `ProductListingItem[]` | Product | Map slug, name, tag, image, price, description, specsList |
| 2 | `GET /api/products/:slug` | `ProductData` | Product + ProductFeature | slug = "x4" or "x3". Include features. |
| 3 | `GET /api/features` | `Feature[]` | Feature | Order by sortOrder |
| 4 | `GET /api/pricing` | `PricingData` | PricingConfig + PricingIncludedItem + TrustBadge + Accessory(pricing) | Composite response, see Â§4.3 |
| 5 | `GET /api/testimonials` | `Testimonial[]` | Testimonial | Order by sortOrder |
| 6 | `GET /api/lifestyle-moments` | `LifestyleMoment[]` | LifestyleMoment | Order by sortOrder |
| 7 | `GET /api/navigation` | `NavLink[]` | NavLink | Order by sortOrder |
| 8 | `GET /api/footer` | `FooterData` | FooterLink + FooterPaymentMethod | Composite, see Â§4.3 |
| 9 | `GET /api/snap-flip-read` | `SnapFlipReadStep[]` | SnapFlipReadStep | Order by sortOrder |
| 10 | `GET /api/product-comparison` | `ProductComparisonData` | Product (x4, x3) | Composite, see Â§4.3 |
| 11 | `GET /api/accessories` | `Accessory[]` | Accessory(standalone) + AccessoryColor | category = "standalone" |
| 12 | `GET /api/purchase-info` | `PurchaseInfoData` | Multiple tables | Composite, see Â§4.3 |
| 13 | `GET /api/faq` | `FAQItem[]` | FAQItem | Order by sortOrder |
| 14 | `GET /api/social-proof` | `SocialProofData` | Multiple tables | Composite, see Â§4.3 |
| 15 | `GET /api/guides` | `Guide[]` | Guide | Order by sortOrder |

### 4.2 Address APIs (BE1.3) â€” 3 endpoints

| # | Endpoint | FE Type | DB Source |
|---|----------|---------|-----------|
| 16 | `GET /api/addresses/provinces` | `Province[]` (without nested districts) | Province |
| 17 | `GET /api/addresses/provinces/:code/districts` | `District[]` (without nested wards) | District |
| 18 | `GET /api/addresses/districts/:code/wards` | `Ward[]` | Ward |

**Important:** FE type `Province` has nested `districts: District[]` which has nested `wards: Ward[]`. But the API returns FLAT lists per level for the cascade select (not deeply nested). The FE checkout form already fetches per-level. Keep it flat for performance.

### 4.3 Checkout API (BE1.4) â€” 1 endpoint

| # | Endpoint | FE Type | DB Source |
|---|----------|---------|-----------|
| 19 | `GET /api/checkout/payment-methods` | `CheckoutPaymentMethod[]` | CheckoutPaymentMethod |

### 4.4 Composite Response Assembly

**`GET /api/pricing` â†’ PricingData:**
```typescript
{
  label: pricingConfig.label,
  price: pricingConfig.price,
  originalPrice: pricingConfig.originalPrice,
  included: pricingIncludedItems.map(i => i.text),    // string[]
  trustBadges: trustBadges,                            // icon as string
  accessories: accessories.where(category="pricing"),  // Accessory[]
}
```

**`GET /api/footer` â†’ FooterData:**
```typescript
{
  productLinks: footerLinks.where(section="product"),
  supportLinks: footerLinks.where(section="support"),
  paymentMethods: footerPaymentMethods.map(m => m.name), // string[]
}
```

**`GET /api/product-comparison` â†’ ProductComparisonData:**
```typescript
{
  x4: buildComparisonModel(product where slug="x4"),
  x3: buildComparisonModel(product where slug="x3"),
}
// buildComparisonModel maps Product fields â†’ ProductComparisonModel shape
```

**`GET /api/purchase-info` â†’ PurchaseInfoData:**
```typescript
{
  paymentMethods: purchasePaymentMethods,   // icon as string
  shippingInfo: shippingInfos,              // icon as string
  warranty: warrantyInfos,                  // icon as string
  bundleItems: bundleItems,                 // icon as string
  freeShippingNote: siteConfig("freeShippingNote"),
}
```

**`GET /api/social-proof` â†’ SocialProofData:**
```typescript
{
  pressReviews: pressReviews,
  youtubeReview: youtubeReview[0],          // single object
  communityStat: siteConfig("communityStat"),
  testimonials: communityTestimonials,
}
```

---

## 5. Response Format

**Success:** Return raw data directly (no wrapper). Match FE expectations.

```json
// GET /api/faq â†’ FAQItem[]
[
  { "question": "E-Ink lÃ  gÃ¬?...", "answer": "..." },
  { "question": "Pin dÃ¹ng Ä‘Æ°á»£c bao lÃ¢u?", "answer": "..." }
]
```

**Error:**
```json
{
  "error": "NOT_FOUND",
  "message": "Product with slug 'x5' not found"
}
```

HTTP status codes: 200 (success), 404 (not found), 500 (server error).

---

## 6. Middleware Stack

```typescript
// app.ts
app.use(cors({ origin: process.env.CORS_ORIGIN || "http://localhost:2002" }));
app.use(express.json());

// Mount routes
app.use("/api", routes);

// Error handler (last)
app.use(errorHandler);
```

---

## 7. Environment Variables

```env
# .env
PORT=3001
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/xteink
CORS_ORIGIN=http://localhost:2002
NODE_ENV=development
```

---

## 8. Seed Data Strategy

`prisma/seed.ts` must populate ALL tables with data matching FE mock files exactly.

**Source of truth:** `website/src/services/mock/*.ts`

**Approach:**
1. Copy all mock data values into seed.ts (plain objects, no LucideIcon imports)
2. Map LucideIcon component names â†’ kebab-case strings (see Â§2 icon table)
3. Seed in dependency order: Province â†’ District â†’ Ward, Product â†’ ProductFeature, Accessory â†’ AccessoryColor
4. Use `prisma.xxx.upsert()` with a stable identifier so seed is idempotent

**Address data (BE1.3):**
- Use `vietnam-provinces` npm package OR import from government open data JSON
- Must cover all 63 provinces, ~700 districts, ~11,000 wards
- Seed separately: `npm run db:seed:addresses`

---

## 9. Package.json Scripts

```json
{
  "scripts": {
    "dev": "nodemon src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "lint": "eslint src/",
    "format": "prettier --write src/",
    "db:migrate": "prisma migrate dev",
    "db:seed": "prisma db seed",
    "db:seed:addresses": "ts-node prisma/seed-addresses.ts",
    "db:reset": "prisma migrate reset",
    "db:studio": "prisma studio"
  }
}
```

---

## 10. Key Dependencies

```json
{
  "dependencies": {
    "express": "^4.21",
    "cors": "^2.8",
    "@prisma/client": "^6.x",
    "dotenv": "^16.x"
  },
  "devDependencies": {
    "typescript": "^5.x",
    "prisma": "^6.x",
    "ts-node": "^10.x",
    "nodemon": "^3.x",
    "@types/express": "^5.x",
    "@types/cors": "^2.x",
    "@types/node": "^22.x",
    "eslint": "^9.x",
    "prettier": "^3.x"
  }
}
```

---

## 11. Route Pattern (Example)

```typescript
// src/routes/faq.ts
import { Router } from "express";
import prisma from "../lib/prisma";

const router = Router();

router.get("/faq", async (_req, res, next) => {
  try {
    const items = await prisma.fAQItem.findMany({
      orderBy: { sortOrder: "asc" },
      select: { question: true, answer: true },
    });
    res.json(items);
  } catch (error) {
    next(error);
  }
});

export default router;
```

**Pattern rules:**
- Use `select` to return only fields FE expects (exclude id, sortOrder, timestamps)
- Always `orderBy: { sortOrder: "asc" }`
- Always wrap in try/catch â†’ `next(error)` for global error handler
- No business logic in routes for Sprint 4. Just query + return.

---

## 12. Implementation Order

```
BE1.1: Setup + Schema          â†’ 1. init project, 2. prisma schema, 3. migrate, 4. seed
BE1.2: Content APIs            â†’ 15 GET endpoints, test each against FE type
BE1.3: Address API             â†’ Import VN data, 3 cascade endpoints
BE1.4: Checkout Payment API    â†’ 1 endpoint, simplest story
```

BE should work on BE1.1 first. I'll review the schema + seed before BE1.2 starts.

---

## 13. Review Checkpoints

| After | TL Reviews |
|-------|-----------|
| BE1.1 done | Schema matches FE types, seed data correct, health endpoint works |
| BE1.2 done | All 15 endpoints return correct shape, test against FE types |
| BE1.3 done | 63 provinces load, cascade works, < 100ms response |
| BE1.4 done | Payment methods match FE mock exactly |

---

## 14. Gotchas & Warnings

1. **Accessory dual-use:** Same `Accessory` model serves both `/api/accessories` (standalone, 3 items with colors) and `/api/pricing` (pricing, 5 items without colors). Filter by `category` field.

2. **Product dual-use:** Same `Product` model serves `/api/products` (listing), `/api/products/:slug` (detail), and `/api/product-comparison` (comparison). Different `select` projections per endpoint.

3. **Icon strings must be exact kebab-case** matching Lucide icon names. If FE adds new icons, update the icon map.

4. **No wrapper objects.** Return raw arrays/objects. FE expects `FAQItem[]` not `{ data: FAQItem[] }`.

5. **Address API returns flat lists per level**, not deeply nested Province â†’ District â†’ Ward trees.

6. **PricingData.included is `string[]`**, not objects. Map from `PricingIncludedItem.text`.

7. **FooterData.paymentMethods is `string[]`**, not objects. Map from `FooterPaymentMethod.name`.

8. **SocialProofData.youtubeReview is a single object**, not an array.

9. **CheckoutPaymentMethod.icon is emoji string** (not Lucide). Different from PurchasePaymentMethod.icon which IS Lucide name.

10. **From coder memory:** For any future POST/upload endpoints (Sprint 5), always implement: duplicate prevention (unique constraints), input validation, referential integrity checks, race condition handling (optimistic locking).
